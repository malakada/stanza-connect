<!DOCTYPE html>
<html>
    <head>
        <script src="FileSaver.js"></script>
        <script src="rtcpeerconnection.bundle.js"></script>
        <script src="filetransfer.bundle.js"></script>
    </head>
    <body>
        <input type="file" id="files" name="files" />
        <script>
// file select
function handleFileSelect(evt) {
    var file = evt.target.files[0]; // FileList object
    console.log('file', file.name, file.size, file.type, file.lastModifiedDate);
    var jingledata = {
        date: file.lastModifiedDate,
        desc: '...',
        name: file.name,
        range: null,
        size: file.size
    }
    console.log('XEP-0234 data', jingledata);
    console.log(JSON.stringify(jingledata));

    filesize = file.size;

    receiver.metadata = {
        name: file.name,
        size: file.size,
        type: file.type
    };

    sender.send(file, sendChannel)
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);

var sender = new FileTransfer.Sender();
sender.on('progress', function (sent, size) {
});
sender.on('sentFile', function (info) {
    console.log('sent file', info);
    
});

var receiver = new FileTransfer.Receiver();
receiver.on('receivedFile', function (file, metadata) {
    console.log('received file', metadata.name,  'hash', metadata.actualhash);
    saveAs(file, metadata.name);
});
receiver.on('progress', function (received, size) {
});
        </script>
        <script>
var pc1, pc2, sendChannel, receiveChannel, pcConstraint;

var servers = null;
pcConstraint = null;
pc1 = new PeerConnection({useJingle: true});
pc2 = new PeerConnection({useJingle: true});

pc1.on('ice', function (candidate) {
    pc2.processIce(candidate);
});
pc2.on('ice', function (candidate) {
    pc1.processIce(candidate);
});

sendChannel = pc1.createDataChannel('filetransfer', {reliable: true});
pc2.on('addChannel', function(channel) {
    receiver.receive(null, channel);
});

var constraints = { mandatory: {
    OfferToReceiveAudio: false,
    OfferToReceiveVideo: false
}};
pc1.offer(constraints, function (err, offer) {
    if (err) {
        console.log('failed to create offer');
        return;
    }
    pc2.handleOffer(offer, function (err) {
        if (err) {
            // handle error
            console.log('error handling offer');
            return;
        }
        pc2.answer(constraints, function (err, answer) {
            if (err) {
                console.log('error handling answer');
                return;
            }
            pc1.handleAnswer(answer, function (err) {
                if (err) {
                    console.log('failed to handle answer');
                    return;
                }
                // FIXME: enable button
                console.log('ready');
            });
        });
    });
});
        </script>
    </body>
</html>
